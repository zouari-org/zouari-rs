networks:
  zouari-network:
    external: true
    name: zouari-network

services:
  # Note: We rely on Coolify's built-in Traefik. 
  # We do NOT define a 'traefik' service here to avoid port conflicts (80/443).

  backend:
  # MATCHES GITHUB ACTION OUTPUT: ghcr.io/<owner>/<repo>-backend
    image: ghcr.io/zouari-org/zouari-rs-backend:${TAG:-prod}
    container_name: zouari-backend-${ENV_TYPE} # e.g. zouari-backend-staging
    restart: always
    environment:
      - 'DOMAIN_BACKEND=${DOMAIN_BACKEND}'
      - 'INFISICAL_CLIENT_ID=${INFISICAL_CLIENT_ID}'
      - 'INFISICAL_CLIENT_SECRET=${INFISICAL_CLIENT_SECRET}'
      - 'INFISICAL_SECRETS_PROJECT_ID=${INFISICAL_SECRETS_PROJECT_ID}'
      - 'INFISICAL_BASE_URL=${INFISICAL_BASE_URL}'
      - 'INFISICAL_TOKEN=${SERVICE_TOKEN_INFISICAL}'
    networks:
      - zouari-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5150/_health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    command: "sh -c \" export INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id=\"${INFISICAL_CLIENT_ID}\" --client-secret=\"${INFISICAL_CLIENT_SECRET}\" --domain \"${INFISICAL_BASE_URL}\" --silent --plain) && infisical run --projectId=${INFISICAL_SECRETS_PROJECT_ID} --env=prod --path=/backend --domain=${INFISICAL_BASE_URL} -- ./zouari-backend start \"\n"

    labels:
      - "traefik.enable=true"

      # Explicitly tell Traefik to route traffic to port 5150 (internal container port)
      - "traefik.http.services.backend.loadbalancer.server.port=5150"

      # ROUTER: api.zouari.org â†’ backend
      - "traefik.http.routers.backend.rule=Host(`${DOMAIN_BACKEND}`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.backend.middlewares=zouari-cors,zouari-secure"

        # CORS Middleware (Parameterized)
      - "traefik.http.middlewares.zouari-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.zouari-cors.headers.accesscontrolalloworiginlist=${CORS_ALLOWED_ORIGIN}"
      - "traefik.http.middlewares.zouari-cors.headers.accesscontrolallowheaders=Content-Type,Authorization"
      - "traefik.http.middlewares.zouari-cors.headers.accesscontrolallowcredentials=true"

        # Security Headers
      - "traefik.http.middlewares.zouari-secure.headers.framedeny=true"
      - "traefik.http.middlewares.zouari-secure.headers.browserxssfilter=true"

  web:
  # MATCHES GITHUB ACTION OUTPUT: ghcr.io/<owner>/<repo>-web
    image: ghcr.io/zouari-org/zouari-rs-web:${TAG:-prod}
    container_name: zouari-web-${ENV_TYPE}
    restart: always
    environment:
      # Fallback for SSR
      - 'DOMAIN_FRONTEND=${DOMAIN_FRONTEND}'
      - 'INFISICAL_CLIENT_ID=${INFISICAL_CLIENT_ID}'
      - 'INFISICAL_CLIENT_SECRET=${INFISICAL_CLIENT_SECRET}'
      - 'INFISICAL_BASE_URL=${INFISICAL_BASE_URL}'
      - 'INFISICAL_SECRETS_PROJECT_ID=${INFISICAL_SECRETS_PROJECT_ID}'
      - 'INFISICAL_TOKEN=${SERVICE_TOKEN_INFISICAL}'
    networks:
      - zouari-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    command: "sh -c \" export INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id=\"${INFISICAL_CLIENT_ID}\" --client-secret=\"${INFISICAL_CLIENT_SECRET}\" --domain \"${INFISICAL_BASE_URL}\" --silent --plain) && cd apps/web && infisical run --projectId=${INFISICAL_SECRETS_PROJECT_ID} --env=prod --path=/frontend --domain=${INFISICAL_BASE_URL} -- node server.js \"\n"

    labels:
        - "traefik.enable=true"

        # Explicitly map internal port 3000 to the router
        - "traefik.http.services.web.loadbalancer.server.port=3000"

        # DYNAMIC DOMAIN RULE
        - "traefik.http.routers.web.rule=Host(`${DOMAIN_FRONTEND}`)"
        - "traefik.http.routers.web.entrypoints=websecure"
        - "traefik.http.routers.web.tls.certresolver=letsencrypt"
        - "traefik.http.routers.web.middlewares=zouari-secure"
